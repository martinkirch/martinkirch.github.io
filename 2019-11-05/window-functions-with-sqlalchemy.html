<!DOCTYPE html>
<html lang="en">
  <head>
    <title> Fetch the "first in a group by" </title>
    <meta name="description" content="Or, using window functions with SQLAlchemy"/>
    <meta name="keywords" content=" data, postgres, in_english" />
    
    <link rel="stylesheet" href="https://unpkg.com/normalize.css">
    <link rel="stylesheet" href="https://unpkg.com/concrete.css">
    <link href="/pygments.css" rel="stylesheet">
    <style>
      body {
        font-family: "Palatino Linotype", "Book Antiqua", Palatino, serif;
      }
      code, kbd, samp, pre {
        font-family: "Courier New", Courier, monospace;
        font-weight: bold;
      }
      section.container p {
        text-align: justify;
      }
    </style>
  </head>
  <body>
    <main>
      <header class="container">
        <div style="float:right;">
          
          
            <a href="/tags.html">Tags</a>
          
          
        </div>
        <p><a href="/">C'est toi le titre</a></p>
        <hr />
      </header>

      
<header class="container">
  <h1>Fetch the "first in a group by"</h1>
  
  
  <p style="float:right">Martin Kirchgessner, 2019-11-05</p>
  
  <p>
    Tags : 
    
    <a href="/tag/data.html">data</a>&nbsp;
    
    <a href="/tag/postgres.html">postgres</a>&nbsp;
    
    <a href="/tag/in_english.html">in_english</a>&nbsp;
    
  </p>
  <hr style="clear:both;"/>
</header>

<section class="container">
  <h1>The problem</h1>
<p>Let's say I have <code>Document</code>s in PostgreSQL, that among other great content
include a <code>folder_id</code> and a <code>date</code>.</p>
<p><strong>How do I fetch (only) the most recent document from each folder ?</strong></p>
<p>In SQL, this is possible by turning folders into windows (also called partitions).
The big difference with <code>GROUP BY</code> is that the engine keeps (and returns, by default) all concerned rows.
It just changes their order, to distinguish groups and maybe order within each group.</p>
<p>Some functions are designed to work on these windows: it's a powerful tool
better explained and illustrated by the 
<a href="http://www.postgresqltutorial.com/postgresql-window-function/">Postgres Tutoriql</a>.
In the following I'll assume you know what they do.</p>
<h1>Explaining this to SQLAlchemy</h1>
<p>To filter rows in a group, <code>GROUP BY</code> can be used with a <code>HAVING</code> clause.
But there's not equivalent for window functions.
With window functions, we can only filter results from a sub-query.
So this sub-query will compute partitions, and return
each document's rank in the partition ;
then top query will only have to keep rows ranking first.</p>
<p>This is where it gets complicated with SQLAlchemy: in the top query we
just want to fetch <code>Document</code>s, but we need a way to describe that
the complete <code>Document</code> comes from the sub-query.
My first and intuitive attempt created a self-join on my documents table.
Instead, we have to use SQLAlchemy aliases.</p>
<p>We firstly have to detail the window function and its grouping/ordering ;
this function is added to the sub-query's selected columns,
and made available by two SQLQlchemy tricks:</p>
<p>```python
rownb = sa.func.row_number().over(order_by=Document.date.desc(), partition_by=Document.folder_id)
rownb = rownb.label('rownb')</p>
<p>subq = session.query(Document, rownb) #Â add interesting filters here</p>
<h1>we need these two lines to match Document columns in subq, and to filter by rownb</h1>
<p>subq = subq.subquery(name="subq", with_labels=True)
q = session.query(sa.orm.aliased(Document, alias=subq)).filter(subq.c.rownb == 1)
```</p>
<p>Hope this helps !</p>
</section>


      <footer class="container" style="font-size:80%; text-align:center;">
        <p>martinkirch.github.io &copy; 2020</p>
      </footer>
    </main>
  </body>
</html>